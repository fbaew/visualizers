<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Layered Visualizer</title>
<style>
body {
    margin: 0;
    overflow: hidden;
    background: #000;
    color: #fff;
    font-family: Arial, sans-serif;
}
canvas.layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}
#controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
}
#settingsDialog {
    position: absolute;
    top: 40px;
    right: 10px;
    background: rgba(0,0,0,0.8);
    padding: 10px;
    border: 1px solid #555;
    display: none;
    color: #fff;
    z-index: 1000;
    max-height: 90vh;
    overflow-y: auto;
}
textarea#presetText { width: 100%; height: 5em; }
label { display: block; margin: 4px 0; }
.layer-config {
    border-bottom: 1px solid #555;
    margin-bottom: 8px;
    padding-bottom: 8px;
}
</style>
</head>
<body>
<div id="controls">
    <button id="toggleSettings">Toggle Settings</button>
    <button id="addLayer">Add Layer</button>
    <button id="removeLayer">Remove Layer</button>
    <button id="randomize">Randomize</button>
    <select id="presetSelect"></select>
    <button id="savePreset">Save</button>
    <button id="loadPreset">Load</button>
</div>
<div id="settingsDialog"></div>
<script>
const defaultParams = [
    {shape:'triangle', scaleX:1, scaleY:1, offsetX:0, offsetY:0, color:'#ff0000', blur:0, speed:1, parallax:0.05},
    {shape:'square',   scaleX:1, scaleY:1, offsetX:0, offsetY:0, color:'#00ff00', blur:0, speed:1, parallax:0.1},
    {shape:'hexagon',  scaleX:1, scaleY:1, offsetX:0, offsetY:0, color:'#0000ff', blur:0, speed:1, parallax:0.15},
];
const presets = {
    Default: defaultParams,
    Rainbow: [
        {shape:'triangle', scaleX:1,   scaleY:1,   offsetX:0, offsetY:0, color:'#ff0000', blur:0,  speed:1,   parallax:0.05},
        {shape:'triangle', scaleX:1.5, scaleY:1.5, offsetX:0, offsetY:0, color:'#00ff00', blur:0,  speed:1.5, parallax:0.1},
        {shape:'triangle', scaleX:2,   scaleY:2,   offsetX:0, offsetY:0, color:'#0000ff', blur:0,  speed:2,   parallax:0.15}
    ],
    BlurrySquares: [
        {shape:'square', scaleX:1, scaleY:1, offsetX:0, offsetY:0, color:'#ff00ff', blur:5,  speed:1, parallax:0.05},
        {shape:'square', scaleX:1, scaleY:1, offsetX:0, offsetY:0, color:'#00ffff', blur:10, speed:1, parallax:0.1},
        {shape:'square', scaleX:1, scaleY:1, offsetX:0, offsetY:0, color:'#ffff00', blur:15, speed:1, parallax:0.15}
    ]
};

const layers = [];
function createLayer(params){
    const index=layers.length;
    const c=document.createElement('canvas');
    c.width=window.innerWidth;
    c.height=window.innerHeight;
    c.className='layer';
    c.style.zIndex=index;
    document.body.appendChild(c);
    layers.push({canvas:c,ctx:c.getContext('2d'),params:{...params}});
}

for(let i=0;i<3;i++) createLayer(defaultParams[i]);
window.addEventListener('resize',()=>{
    layers.forEach(l=>{ l.canvas.width=window.innerWidth; l.canvas.height=window.innerHeight; });
});

function removeLayer(){
    if(layers.length===0) return;
    const l=layers.pop();
    l.canvas.remove();
}

function randomizeLayer(l){
    const shapes=['triangle','square','hexagon'];
    l.params.shape=shapes[Math.floor(Math.random()*shapes.length)];
    l.params.scaleX=Math.random()*1.5+0.5;
    l.params.scaleY=Math.random()*1.5+0.5;
    l.params.offsetX=(Math.random()-0.5)*200;
    l.params.offsetY=(Math.random()-0.5)*200;
    l.params.color=`hsl(${Math.floor(Math.random()*360)},100%,50%)`;
    l.params.blur=Math.floor(Math.random()*10);
    l.params.speed=Math.random()*2+0.5;
    l.params.parallax=Math.random()*0.2;
}

function randomizeAll(){
    layers.forEach(randomizeLayer);
    createSettings();
}

function applyPreset(name){
    const preset=presets[name];
    if(!preset) return;
    layers.forEach((l,i)=>{
        const p=preset[i%preset.length];
        l.params={...p};
    });
    createSettings();
}

function addLayer(){
    const params=defaultParams[layers.length%defaultParams.length];
    createLayer(params);
    createSettings();
}
function drawShape(ctx,shape,size){
    ctx.beginPath();
    if(shape==='square'){
        ctx.rect(-size/2,-size/2,size,size);
    } else if(shape==='triangle'){
        ctx.moveTo(0,-size/2);
        ctx.lineTo(size/2,size/2);
        ctx.lineTo(-size/2,size/2);
        ctx.closePath();
    } else if(shape==='hexagon'){
        for(let i=0;i<6;i++){
            const a=(Math.PI*2/6)*i;
            const x=Math.cos(a)*size/2;
            const y=Math.sin(a)*size/2;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.closePath();
    }
    ctx.fill();
}
let pointerX=0, pointerY=0;
window.addEventListener('mousemove',e=>{
    pointerX=(e.clientX-window.innerWidth/2)/window.innerWidth;
    pointerY=(e.clientY-window.innerHeight/2)/window.innerHeight;
});
function animate(time){
    layers.forEach(l=>{
        const {ctx, canvas, params}=l;
        ctx.fillStyle='rgba(0,0,0,0.1)';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.save();
        ctx.translate(
            canvas.width/2+params.offsetX+pointerX*canvas.width*params.parallax,
            canvas.height/2+params.offsetY+pointerY*canvas.height*params.parallax
        );
        ctx.fillStyle=params.color;
        ctx.globalAlpha=0.6;
        ctx.filter=`blur(${params.blur}px)`;
        ctx.globalCompositeOperation='lighter';
        const step=40;
        const scaleX=params.scaleX;
        const scaleY=params.scaleY;
        const rot=time*0.0002*params.speed;
        for(let x=-canvas.width;x<canvas.width;x+=step*scaleX){
            for(let y=-canvas.height;y<canvas.height;y+=step*scaleY){
                ctx.save();
                ctx.translate(x,y);
                ctx.rotate(rot);
                drawShape(ctx,params.shape,step*0.8);
                ctx.restore();
            }
        }
        ctx.restore();
        ctx.globalCompositeOperation='source-over';
        ctx.globalAlpha=1;
        ctx.filter='none';
    });
    requestAnimationFrame(animate);
}
requestAnimationFrame(animate);
function createSettings(){
    const container=document.getElementById('settingsDialog');
    container.innerHTML='';
    layers.forEach((l,idx)=>{
        const div=document.createElement('div');
        div.className='layer-config';
        div.innerHTML=`<strong>Layer ${idx+1}</strong>`;
        const fields=[
            ['shape','select',['triangle','square','hexagon']],
            ['scaleX','number'],
            ['scaleY','number'],
            ['offsetX','number'],
            ['offsetY','number'],
            ['color','color'],
            ['blur','number'],
            ['speed','number'],
            ['parallax','number']
        ];
        fields.forEach(f=>{
            const label=document.createElement('label');
            let input;
            if(f[1]==='select'){
                input=document.createElement('select');
                f[2].forEach(opt=>{
                    const o=document.createElement('option');
                    o.value=opt;o.textContent=opt;input.appendChild(o);});
                input.value=l.params.shape;
            } else {
                input=document.createElement('input');
                input.type=f[1];
                input.value=l.params[f[0]];
                if(f[1]==='number') input.step='0.1';
            }
            input.oninput=()=>{ l.params[f[0]]=f[1]==='number'?parseFloat(input.value):input.value; };
            label.textContent=f[0]+': ';
            label.appendChild(input);
            div.appendChild(label);
        });
        container.appendChild(div);
    });
    const ta=document.createElement('textarea');
    ta.id='presetText';
    ta.placeholder='Preset JSON';
    ta.value=localStorage.getItem('layeredPreset')||'';
    container.appendChild(ta);
}
createSettings();
document.getElementById('toggleSettings').onclick=()=>{
    const dlg=document.getElementById('settingsDialog');
    dlg.style.display=dlg.style.display==='none'?'block':'none';
};
document.getElementById('addLayer').onclick=addLayer;
document.getElementById('removeLayer').onclick=()=>{ removeLayer(); createSettings(); };
document.getElementById('randomize').onclick=randomizeAll;
const presetSelect=document.getElementById('presetSelect');
Object.keys(presets).forEach(name=>{
    const o=document.createElement('option');
    o.value=name; o.textContent=name; presetSelect.appendChild(o);
});
presetSelect.onchange=()=>{ applyPreset(presetSelect.value); };
document.getElementById('savePreset').onclick=()=>{
    const data=JSON.stringify(layers.map(l=>l.params));
    localStorage.setItem('layeredPreset',data);
    document.getElementById('presetText').value=data;
};
document.getElementById('loadPreset').onclick=()=>{
    let data=document.getElementById('presetText').value.trim();
    if(!data) data=localStorage.getItem('layeredPreset');
    if(!data) return;
    try{
        const arr=JSON.parse(data);
        arr.forEach((p,i)=>{
            if(i<layers.length) layers[i].params={...layers[i].params,...p};
            else createLayer(p);
        });
        while(layers.length>arr.length) removeLayer();
        createSettings();
    }catch(e){
        alert('Invalid preset');
    }
};
</script>
</body>
</html>
